import { supabase } from '/components/supabaseClient';
import LightboxComponent from '/components/LightboxComponent';
import { Callout } from 'nextra/components';
import fs from 'fs';
import path from 'path';

export const getStaticProps = async ({ params }) => {
  const { model } = params;

  // Fetch SKUs from filenames.txt
  const filePath = path.join(process.cwd(), 'public', 'filenames.txt');
  const fileContents = fs.readFileSync(filePath, 'utf-8');
  const matchingModels = fileContents
    .split('\n')
    .filter((line) => line.startsWith(model))
    .map((line) => line.trim());

  // Fetch additional data for the SKU from Supabase
  const { data, error } = await supabase
    .from('phone')
    .select('model, material, colour')
    .eq('SKU', model)
    .maybeSingle();  // since each SKU is unique

  if (error) {
    console.error("Error fetching data from Supabase:", error);
    return { notFound: true };
  }

  if (!data) {
    // Handle case where no data is returned for the model
    console.warn(`No data found for model: ${model}`);
    return { notFound: true };
  }

  const modelNumberMatch = data.model.match(/iPhone (\d+)/);
  const isMagSafeModel = modelNumberMatch && parseInt(modelNumberMatch[1], 10) >= 12;

  const caseName = isMagSafeModel
    ? `${data.model} ${data.material} with MagSafe â€” ${data.colour}`
    : `${data.model} ${data.material} â€” ${data.colour}`;

  return {
    props: {
      modelName: model,
      matchingModels,
      caseName,
    },
  };
};
//specify next which pages must be pre-rendered

export const getStaticPaths = async () => {
  const filePath = path.join(process.cwd(), 'public', 'filenames.txt');
  const fileContents = fs.readFileSync(filePath, 'utf-8');
  const uniqueSKUs = Array.from(
    new Set(fileContents.split('\n').map((line) => line.split('_')[0].trim()))
  );

  const paths = uniqueSKUs.map((sku) => ({
    params: { model: sku },
  }));

  return {
    paths,
    fallback: 'blocking',
  };
};

export default function ModelPage({ modelName, matchingModels, caseName }) {
  const images = matchingModels.map((variant) => ({
    src: `https://cloudfront.everycase.org/everysource/${variant}.webp`,
  }));

  // regarding h1: I could not find a way to do this gracefully, so I've simply copied CSS so far
  return (
    <>
      <h1 className="_mt-2 _text-4xl _font-bold _tracking-tight _text-slate-900 dark:_text-slate-100">{caseName}</h1>
      <Callout type="info" emoji="ðŸ‘‰ðŸ»">
        <strong>{modelName}ZM</strong> is an order number for this product, used for search engines, auction websites
        and such.
      </Callout>
      <div style={{ marginTop: '1rem' }}>
        <LightboxComponent images={images} />
      </div>
    </>
  );
}